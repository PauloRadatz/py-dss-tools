# -*- coding: utf-8 -*-
# @Author  : Raphael Maccari
# @Email   : raphaelmaccari@gmail.com
# @File    : VTCDVulnerabilityCircuit.py
# @Software: PyCharm

from py_dss_interface import DSS
from py_dss_tools.results import VTCDresults
import time


class VTCDVulnerabilityCircuit:

    # def __init__(self, dss: DSS, results = None):
    def __init__(self, dss: DSS, results):
    # def __init__(self, dss: DSS, results: VTCDresults): #Qualquer um dos 2 def acima dá certo. Troquei para results: VTCDSag e fiz o import do VTCDSag lá em cima.
        self._results = results
        self._dss = dss
        self.vmags_df = None


    def vtcd_vulnerability_circuit_sc3ph(self):

        if self._results is None:
            raise ValueError("VTCDresults object not set. Call set_results method first.")

        vmags_df_circuit = self._results.vmags_df # também dá certo sem o import e com o dito lá no init "results=None".

        if vmags_df_circuit.empty:
            raise ValueError("vmags_df is empty. Run vulnerability_sag_map_sc3ph method first.")

        # for index, row in self._results.vmags_df.iterrows(): # Esse também dá certo !!!
        for index, row in vmags_df_circuit.iterrows():
            bus_name = index  # Obtém o valor da primeira coluna (bus_name)
            color = row.iloc[-1]  # Obtém o valor da última coluna (color)
            self._dss.text(f"AddBusMarker Bus={bus_name} code=7 color={color} size=10")
        self._dss.text("plot circuit Power max=2000 n y C1=$00FF0000")

    def vtcd_vulnerability_circuit_sc1ph(self):

        if self._results is None:
            raise ValueError("VTCDresults object not set. Call set_results method first.")

        vmags_df_circuit = self._results.vmags_df # também dá certo sem o import e com o dito lá no init "results=None".

        if vmags_df_circuit.empty:
            raise ValueError("vmags_df is empty. Run vulnerability_sag_map_sc1ph method first.")

        # for index, row in self._results.vmags_df.iterrows(): # Esse também dá certo !!!
        for index, row in vmags_df_circuit.iterrows():
            bus_name = index  # Obtém o valor da primeira coluna (bus_name)
            color = row['colors_sag']  # Obtém o valor da coluna "colors_sag"
            self._dss.text(f"AddBusMarker Bus={bus_name} code=7 color={color} size=10")
        self._dss.text("plot circuit Power max=2000 n y C1=$00FF0000")

        time.sleep(1)

        self._dss.text(f"ClearBusMarkers") # Fiz isso não repetir as cores

        for index, row in vmags_df_circuit.iterrows():
            bus_name = index  # Obtém o valor da primeira coluna (bus_name)
            color = row['colors_swell']  # Obtém o valor da coluna "colors_swell"
            self._dss.text(f"AddBusMarker Bus={bus_name} code=7 color={color} size=10")
        self._dss.text("plot circuit Power max=2000 n y C1=$00FF0000")
